<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-initial-scale=1.0">
    <title>PDF Data Extractor (Form/Passbook)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // User's requested theme colors
                        'primary-blue': 'rgba(0, 102, 255, 0.6)', 
                        'dark-bg': 'rgba(29, 29, 29, 0.7)', 
                        'success-green': '#00ff55',
                    }
                }
            }
        }
    </script>
    <!-- PDF.js - MUST be loaded before use -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Set the worker source for PDF.js (Mandatory for it to work)
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-4xl mx-auto">
       

        <!-- Input and Control Area -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <label for="pdfFile" class="block text-lg font-medium mb-3">
                PDF अपलोड करें (पासबुक या अकाउंट ओपनिंग फॉर्म)
            </label>
            <input type="file" id="pdfFile" accept="application/pdf" class="w-full text-sm text-gray-300
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-primary-blue file:text-white
                hover:file:bg-blue-600 cursor-pointer mb-4
            ">
            
            <button onclick="processPDF()" id="extractButton"
                class="w-full md:w-auto px-6 py-3 bg-primary-blue text-white font-bold rounded-lg transition duration-150 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-md"
                >
               Upload
            </button>
            <div id="statusMessage" class="mt-4 text-sm text-yellow-400 hidden"></div>
        </div>

        <!-- Formatted Output Area -->
        <h2 class="text-2xl font-bold mb-4 text-white"></h2>
        <pre id="output" class="bg-white text-black p-4 rounded-xl overflow-x-auto border border-primary-blue/30 text-base shadow-inner">
          
        </pre>
    </div>

    <script>
        const statusMessage = document.getElementById('statusMessage');
        const outputElement = document.getElementById('output');
        const extractButton = document.getElementById('extractButton');
        const N_A = "N/A";
        const BRANCH_INFO = {
            BO: "BISHUNPUR CHATTI",
            ADDRESS_LINE: "BISHUNPUR CHATTI DEO , AURANGABAD - 824202 (Phone: )",
            MICR_CODE: "0",
            IFSC_CODE: "PUNB0MBGB06"
        };


        /**
         * Retries the fetch operation with exponential backoff if a transient error occurs.
         */
        async function fetchWithExponentialBackoff(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Extracts raw text content from a PDF file using PDF.js.
         */
        async function extractTextFromPDF(file) {
            const pdf = await fetchWithExponentialBackoff(() => 
                pdfjsLib.getDocument(URL.createObjectURL(file)).promise
            );

            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                // Join text content, adding a space to separate words from different items
                const pageText = text.items.map(t => t.str).join(" ");
                // Use a separator that is unlikely to appear naturally in the text
                fullText += pageText + " |SEPARATOR| "; 
            }

            return fullText;
        }

        /**
         * Masks 12-digit numbers (like Aadhaar) by showing only the last 4 digits.
         */
        function maskAadhaar(text) {
            return text.replace(/\b\d{12}\b/g, m => "XXXXXXXX" + m.slice(-4));
        }

        /**
         * Parses the raw text to extract structured data (Passbook or AOF format).
         */
        function parseData(text) {
            const data = {};
            
            // --- Common Fields ---
            data.customerNo = (text.match(/Customer\s*(?:No|ID)\.?\s*[:\s]+([A-Z0-9]+)/i) || [])[1]?.trim() || N_A;
            data.accountNo = (text.match(/Account\s*No\.?\s*[:\s]+([0-9\s]+)/i) || [])[1]?.replace(/\s+/g, ' ').trim() || N_A;
            data.micrCode = (text.match(/MICR\s*Code\s*[:\s]+([0-9A-Z]+)/i) || [])[1]?.trim() || BRANCH_INFO.MICR_CODE;
            data.ifscCode = (text.match(/IFSC\s*Code\s*[:\s]+([0-9A-Z]+)/i) || [])[1]?.trim() || BRANCH_INFO.IFSC_CODE;
            data.issueDate = (text.match(/Date\s*of\s*Issue\s*[:\s]+([0-9\s\-/]+)/i) || [])[1]?.trim() || N_A;
            data.nomination = (text.match(/Nomination\s*Registered\s*at\s*Sl\.No\s*[:\s]+([0-9]+)/i) || [])[1]?.trim() || N_A;

            // --- 1. AOF (Account Opening Form) Extraction Logic ---
            if (text.includes("Account Opening Form")) {
                data.documentType = "AOF";
                
                // CKYC Name 
                const regexCustomerName = text.match(/Customer\s*Name\s*([\s\S]+?)\s*Sex/i);
                data.name = regexCustomerName ? regexCustomerName[1].split('|SEPARATOR|')[0].trim() : N_A;

                // Relation Type and Name (W/O: Bishundev Rikiyasan,, VILL...)
                const regexRelation = text.match(/(W\/O|S\/O|D\/O)\s*[:\s]+([\s\S]+?)\s*(VILL|PO|AROURA|MAHUA)/i);
                data.relationType = regexRelation ? regexRelation[1].trim() : "W/O/S/O";
                data.relationName = regexRelation ? regexRelation[2].split(',,')[0].trim() : N_A;

                // Address Block (VILL - MAHUA DOHAR, PO - AROURA, PS - DEO...)
                const regexAddressBlock = text.match(/VILL\s*-\s*([\s\S]+?)\s*(BIHAR|INDIA),\s*(\d{6})/i);
                
                if (regexAddressBlock) {
                    const rawAddress = regexAddressBlock[1].trim().replace(/\s*\|SEPARATOR\|\s*/g, ' ');
                    data.pin = regexAddressBlock[3].trim() || N_A;
                    
                    // Split address based on common separators
                    const parts = rawAddress
                        .split(/,\s*|PO\s*-\s*|VILL\s*-\s*|PS\s*-\s*/) 
                        .map(p => p.trim())
                        .filter(p => p.length > 3);
                    
                    data.addr1 = parts[0] || N_A;
                    data.addr2 = parts[1] || N_A;
                    data.addr3 = parts[2] || N_A;
                } else {
                    data.pin = N_A;
                    data.addr1 = N_A;
                    data.addr2 = N_A;
                    data.addr3 = N_A;
                }
                
                // Fallback for D/O if available (AOF doesn't use D/O explicitly)
                data.dOValue = N_A;


            } else { 
                // --- 2. Passbook Printout Extraction Logic ---
                data.documentType = "Passbook";
                
                // CKYC Name (Search between CKYC and Relation field)
                const nameMatch = text.match(/CKYC\s*[:\s]+([\s\S]+?)\s*(S\/O|W\/O|D\/O|Account No|Aadhar)/i);
                data.name = nameMatch ? nameMatch[1].trim() : N_A;

                // Relation Name
                const relationMatch = text.match(/S\/O,D\/O,W\/O\s*[:\s]+([A-Za-z\s]+)/i);
                data.relationName = relationMatch ? relationMatch[1].trim() : N_A;
                
                // D/O value 
                data.dOValue = (text.match(/D\/O\s*[:\s]+([A-Za-z\s]+)/i) || [])[1]?.trim() || N_A;
                
                // PIN CODE
                data.pin = (text.match(/Pin\s*[:\s]+(\d{6})\b/i) || [])[1] || N_A;

                // ADDRESS BLOCK (Capture the multi-line address from Passbook)
                // Start after Relation Name line and end before BIHAR
                const relationEnd = data.relationName ? data.relationName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : N_A;
                const addressRegex = new RegExp(`D\\/O:\\s*${relationEnd},?([\\s\\S]+?)\\s*BIHAR`, 'i');
                
                const addressBlockMatch = text.match(addressRegex);
                
                if (addressBlockMatch && addressBlockMatch[1]) {
                    const rawAddress = addressBlockMatch[1].trim().replace(/\s*\|SEPARATOR\|\s*/g, ' ');
                    
                    // Split address based on separators
                    const parts = rawAddress
                        .split(/,\s*|\n|\s{3,}/) 
                        .map(p => p.trim())
                        .filter(p => p.length > 5 && !p.match(/^\d{6}$/)); 
                    
                    data.addr1 = parts[0] || N_A;
                    data.addr2 = parts[1] || N_A;
                    data.addr3 = parts[2] || N_A;
                } else {
                    data.addr1 = N_A;
                    data.addr2 = N_A;
                    data.addr3 = N_A;
                }

            }

            return data;
        }

        /**
         * Fills the extracted data into the EXACT Passbook Output Template requested by the user.
         */
        function formatOutput(text) {
            text = maskAadhaar(text);
            const data = parseData(text);
            
            // Default values for fields that might be empty
            const customerNo = data.customerNo || N_A;
            const accountNo = data.accountNo || N_A;
            const name = data.name || N_A;
            const relation = data.relationName || N_A;
            const dOValue = data.dOValue || N_A;
            const addr1 = data.addr1 || N_A;
            const addr2 = data.addr2 || N_A;
            const addr3 = data.addr3 || N_A;
            const pin = data.pin || N_A;
            const nomination = data.nomination || N_A;
            const issueDate = data.issueDate || N_A;
            
            // FINAL OUTPUT TEMPLATE - EXACT LIKE PRINTED PASSBOOK (Requested Format)
            const output = `

BIHAR GRAMIN BANK
BO : ${BRANCH_INFO.BO}
${BRANCH_INFO.ADDRESS_LINE}

MICR Code:${data.micrCode}
IFSC Code: ${data.ifscCode}
*****

Mode of Operation : SELF
Customer No. : ${customerNo}
Account No. : ${accountNo}    INR
CKYC :
 ${name}
S/O,D/O,W/O : ${relation}
D/O: ${relation}

${addr1}
${addr2}
${addr3}
BIHAR           INDIA
Pin : ${pin}

Nomination Registered at Sl.No. : ${nomination}
Date of Issue : ${issueDate}

**Computer generated entries shown in the statement 
of account do not require any authentication.
*** OUR ATM/DEBIT CARDS CAN ALSO BE USED AT ATMS 
OF MITR, SBI & NFS WITH NOMINAL CHARGES ***
`;

            return output;
        }

        /**
         * Main function to handle file upload and PDF processing.
         */
        async function processPDF() {
            const file = document.getElementById("pdfFile").files[0];
            statusMessage.classList.add('hidden');
            outputElement.textContent = 'Upload a PDF and click "डेटा निकालें" to see the results here.';
            
            if (!file) {
                statusMessage.textContent = "Error: कृपया पहले एक PDF फाइल अपलोड करें।";
                statusMessage.classList.remove('hidden');
                return;
            }

            // UI state management
            extractButton.disabled = true;
            extractButton.textContent = 'PDF को प्रोसेस किया जा रहा है...';
            outputElement.textContent = 'डॉक्यूमेंट लोड और पार्स किया जा रहा है... कृपया प्रतीक्षा करें।';

            try {
                // 1. Extract raw text
                statusMessage.textContent = "Step 1/2: PDF पेजों से टेक्स्ट निकाला जा रहा है...";
                statusMessage.classList.remove('hidden');
                const text = await extractTextFromPDF(file);
                
                // 2. Format and parse data
                statusMessage.textContent = "Step 2/2: डेटा फॉर्मेट और संवेदनशील जानकारी को मास्क किया जा रहा है...";
                const formatted = formatOutput(text);

                // 3. Display result
                outputElement.textContent = formatted;
                statusMessage.textContent = "डेटा सफलतापूर्वक निकाल लिया गया है!";
                statusMessage.classList.remove('text-yellow-400', 'text-red-400');
                statusMessage.classList.add('text-success-green');


            } catch (error) {
                console.error("PDF Processing Error:", error);
                statusMessage.textContent = `एक त्रुटि हुई: ${error.message}। कृपया कंसोल (console) में विवरण देखें।`;
                statusMessage.classList.remove('text-yellow-400', 'text-success-green');
                statusMessage.classList.add('text-red-400');
                outputElement.textContent = 'ERROR: PDF को प्रोसेस करने में विफल रहा। सुनिश्चित करें कि फाइल मान्य है और पासवर्ड से सुरक्षित नहीं है।';

            } finally {
                // Reset UI state
                extractButton.disabled = false;
                extractButton.textContent = 'डेटा निकालें';
                statusMessage.classList.remove('hidden');
            }
        }
    </script>

</body>
</html>