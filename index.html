<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-initial-scale=1.0">
    <title>PDF Data Extractor (Form/Passbook)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Personalized style: blue color with 600 opacity for buttons
                        'primary-blue': '#2563EB', // Tailwind blue-600
                        // Personalized style: black with 30% opacity (0.7 alpha on gray-900 base)
                        'dark-bg': 'rgba(29, 29, 29, 0.7)', 
                        'success-green': '#00ff55',
                    }
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-4xl mx-auto">

        <div class="bg-dark-bg p-6 rounded-lg shadow-xl mb-8 border border-white/10"> 
            <label for="pdfFile" class="block text-lg font-medium mb-3">
                PDF अपलोड करें (पासबुक या अकाउंट ओपनिंग फॉर्म)
            </label>

            <input type="file" id="pdfFile" accept="application/pdf"
                class="w-full text-sm text-gray-300
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-primary-blue file:text-white
                hover:file:bg-blue-700 cursor-pointer mb-4">

            <button onclick="processPDF()" id="extractButton"
                class="w-full md:w-auto px-6 py-3 bg-primary-blue text-white font-bold rounded-lg
                transition duration-150 hover:bg-blue-700 focus:outline-none 
                focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 
                focus:ring-offset-gray-900 shadow-md">
                Upload
            </button>

            <div id="statusMessage" class="mt-4 text-sm text-yellow-400 hidden"></div>
        </div>

        <h2 class="text-2xl font-bold mb-4 text-white"></h2>

        <pre id="output"
            class="bg-white text-black p-4 rounded-xl overflow-x-auto border border-primary-blue/30 
            text-base shadow-inner uppercase">
        </pre>
    </div>

    <script>
        const statusMessage = document.getElementById('statusMessage');
        const outputElement = document.getElementById('output');
        const extractButton = document.getElementById('extractButton');
        const N_A = "N/A";

        // Indentation for output formatting
        const INDENTATION = "    "; // 4 non-breaking spaces for alignment

        const BRANCH_INFO = {
            BO: "BISHUNPUR CHATTI",
            ADDRESS_LINE: "BISHUNPUR CHATTI DEO , AURANGABAD - 824202 (PHONE: )",
            MICR_CODE: "0",
            IFSC_CODE: "PUNB0MBGB06"
        };

        async function fetchWithExponentialBackoff(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try { return await fn(); }
                catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        async function extractTextFromPDF(file) {
            const pdf = await fetchWithExponentialBackoff(() =>
                pdfjsLib.getDocument(URL.createObjectURL(file)).promise
            );

            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                fullText += text.items.map(t => t.str).join(" ") + " |SEPARATOR| ";
            }
            return fullText;
        }

        function maskAadhaar(text) {
            return text.replace(/\b\d{12}\b/g, m => "XXXXXXXX" + m.slice(-4));
        }

        function determineSalutation(text) {
            // Search for Wife/Widow Of (W/O) or Daughter Of (D/O) in the relationship field
            if (/(W\/O|D\/O)\s*[:\s]+([A-Za-z\s]+)/i.test(text)) {
                return "MRS.";
            } 
            // If the text contains S/O (Son of) and not W/O/D/O, assume male.
            else if (/(S\/O)\s*[:\s]+([A-Za-z\s]+)/i.test(text)) {
                return "MR.";
            }
            // Fallback if no relationship indicator is found
            return "SHRI/SMT."; 
        }

        function parseData(text) {
            const data = {};
            
            // --- Determine Salutation First ---
            const salutation = determineSalutation(text);
            data.salutation = salutation;
            // ----------------------------------

            data.customerNo =
                (text.match(/Customer\s*(?:No|ID)\.?\s*[:\s]+([A-Z0-9]+)/i) || [])[1]?.trim() || N_A;

            data.accountNo =
                (text.match(/Account\s*No\.?\s*[:\s]+([0-9\s]+)/i) || [])[1]?.trim() || N_A;

            data.micrCode =
                (text.match(/MICR\s*Code\s*[:\s]+([0-9A-Z]+)/i) || [])[1] || BRANCH_INFO.MICR_CODE;

            data.ifscCode =
                (text.match(/IFSC\s*Code\s*[:\s]+([0-9A-Z]+)/i) || [])[1] || BRANCH_INFO.IFSC_CODE;

            data.issueDate =
                (text.match(/Date\s*of\s*Issue\s*[:\s]+([0-9\s\-/]+)/i) || [])[1] || N_A;

            data.nomination =
                (text.match(/Nomination\s*Registered\s*at\s*Sl\.No\s*[:\s]+([0-9]+)/i) || [])[1] || N_A;

            // --- Name Extraction Logic ---
            let rawName = N_A;

            if (text.includes("Account Opening Form")) {
                const nm = text.match(/Customer\s*Name\s*([\s\S]+?)\s*Sex/i);
                rawName = nm ? nm[1].split("|SEPARATOR|")[0].trim() : N_A;

                const rel = text.match(/(W\/O|S\/O|D\/O)\s*[:\s]+([\s\S]+?)\s*(VILL|PO|AROURA)/i);
                data.relationName = rel ? rel[2].split(",,")[0].trim() : N_A;

                const addr = text.match(/VILL\s*-\s*([\s\S]+?)\s*(BIHAR|INDIA),\s*(\d{6})/i);
                if (addr) {
                    const parts = addr[1].replace(/\|SEPARATOR\|/g, " ")
                        .split(/,\s*|PO\s*-\s*|VILL\s*-\s*|PS\s*-\s*/)
                        .map(x => x.trim()).filter(x => x.length > 3);

                    data.addr1 = parts[0] || N_A;
                    data.addr2 = parts[1] || N_A;
                    data.addr3 = parts[2] || N_A;
                    data.pin = addr[3];
                } else {
                    data.addr1 = data.addr2 = data.addr3 = data.pin = N_A;
                }

            } else { // Passbook logic
                const nm = text.match(/CKYC\s*[:\s]+([\s\S]+?)\s*(S\/O|W\/O|D\/O|ACCOUNT NO)/i); 
                rawName = nm ? nm[1].trim() : N_A; 

                const rel = text.match(/S\/O,D\/O,W\/O\s*[:\s]+([A-Za-z\s]+)/i);
                data.relationName = rel ? rel[1].trim() : N_A;

                data.dOValue =
                    (text.match(/D\/O\s*[:\s]+([A-Za-z\s]+)/i) || [])[1] || N_A;

                data.pin =
                    (text.match(/Pin\s*[:\s]+(\d{6})/i) || [])[1] || N_A;

                data.addr1 = data.addr2 = data.addr3 = N_A;
            }
            
            // Clean the raw name by removing existing common salutations before prepending the new one
            rawName = rawName.replace(/^(MR\.?|MRS\.?|MS\.?|DR\.?|SHRI\.?|SMT\.?)\s*/i, '').trim();
            
            // Prepend the determined salutation (Removed the colon ':' after salutation)
            data.name = `${salutation} : ${rawName}`;

            return data;
        }

        function formatOutput(text) {
            text = maskAadhaar(text);
            const d = parseData(text);
            const EXTRA_INDENT = "          "; 

            return `
${INDENTATION}${EXTRA_INDENT}BIHAR GRAMIN BANK
${INDENTATION}${EXTRA_INDENT}BO : ${BRANCH_INFO.BO}
${INDENTATION}${EXTRA_INDENT}${BRANCH_INFO.ADDRESS_LINE}

${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}MICR CODE: ${d.micrCode}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}IFSC CODE: ${d.ifscCode}
${INDENTATION}*****

${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}MODE OF OPERATION : SELF
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}CUSTOMER NO. : ${d.customerNo}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}ACCOUNT NO. : ${d.accountNo}    INR
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}CKYC :
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}${d.name}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}S/O,D/O,W/O : ${d.relationName}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}D/O: ${d.relationName}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}${d.addr1}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}${d.addr2}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}${d.addr3}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}BIHAR            INDIA
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}PIN : ${d.pin}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}NOMINATION REGISTERED AT SL.NO. : ${d.nomination}
${INDENTATION}${EXTRA_INDENT}${EXTRA_INDENT}DATE OF ISSUE : ${d.issueDate}
${INDENTATION}${EXTRA_INDENT}**COMPUTER GENERATED ENTRIES SHOWN IN THE STATEMENT 
${INDENTATION}${EXTRA_INDENT}OF ACCOUNT DO NOT REQUIRE ANY AUTHENTICATION/INITIAL
${INDENTATION}${EXTRA_INDENT}FROM BANK OFFICIAL. PLEASE DO NOT ACCEPT ANY MANUAL.
${INDENTATION}${EXTRA_INDENT}***- OUR ATM/DEBIT CARDS CAN ALSO BE USED AT ATMS 
${INDENTATION}${EXTRA_INDENT}OF MITR, SBI & NFS WITH NOMINAL CHARGES -***
`;
        }

        async function processPDF() {
            const file = document.getElementById("pdfFile").files[0];
            statusMessage.classList.remove("text-success-green", "text-red-400");
            statusMessage.classList.add("hidden", "text-yellow-400");

            if (!file) {
                statusMessage.textContent = "ERROR: कृपया PDF अपलोड करें।";
                statusMessage.classList.remove("hidden");
                statusMessage.classList.add("text-red-400");
                return;
            }

            extractButton.disabled = true;
            extractButton.textContent = "PROCESSING…";
            outputElement.textContent = "PROCESSING PDF…";

            try {
                const text = await extractTextFromPDF(file);
                const formatted = formatOutput(text);
                outputElement.textContent = formatted;

                statusMessage.textContent = "SUCCESSFULLY EXTRACTED!";
                statusMessage.classList.remove("text-yellow-400");
                statusMessage.classList.add("text-success-green");

            } catch (err) {
                console.error(err);
                outputElement.textContent = "ERROR PROCESSING PDF.";
                statusMessage.textContent = "ERROR: " + (err.message || "अनपेक्षित त्रुटि।");
                statusMessage.classList.remove("text-yellow-400");
                statusMessage.classList.add("text-red-400");
            }

            extractButton.disabled = false;
            extractButton.textContent = "UPLOAD";
            statusMessage.classList.remove("hidden");
        }
    </script>

</body>
</html>
